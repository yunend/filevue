<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GGBç¼–è¾‘ - æ–‡ä»¶è§†ç•Œ</title>
    <link rel="stylesheet" href="../css/bootstrap4.min.css">
    <link rel="stylesheet" href="../css/fileVue.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="shortcut icon" href="../images/ggblogo.ico" type="image/x-icon">
    <script src="./GeoGebra/deployggb.js"></script>
    <script src="../js/filevue.js"></script>
    <style>
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: auto;
        }




        /* loadingåŠ¨ç”» */
        .sk-spinner-pulse {
            position: absolute;
            /* transform: translate(-50%, -50%); */
            width: 150px;
            height: 150px;
            background-color: #1ab394;
            border-radius: 100%;
            -webkit-animation: sk-pulseScaleOut 1s infinite ease-in-out;
            animation: sk-pulseScaleOut 1s infinite ease-in-out;
        }

        @-webkit-keyframes sk-pulseScaleOut {
            0% {
                -webkit-transform: scale(0);
                transform: scale(0);
            }

            100% {
                -webkit-transform: scale(1);
                transform: scale(1);
                opacity: 0;
            }
        }

        @keyframes sk-pulseScaleOut {
            0% {
                -webkit-transform: scale(0);
                transform: scale(0);
            }

            100% {
                -webkit-transform: scale(1);
                transform: scale(1);
                opacity: 0;
            }
        }

        #loading {
            position: absolute;
            /* ä¿®æ”¹ï¼šä» fixed æ”¹ä¸º absolute */
            z-index: 99999;
        }

        /* è°ƒæ•´ggbå®¹å™¨ */
        .ggb-container {
            /* flex: 1; */
            width: 85%;
            /* è°ƒæ•´å®½åº¦ */
            margin: auto;
            aspect-ratio: 128/72;
            position: relative;
            padding: 0;
            overflow: hidden;
            display: flex;
            /* æ–°å¢ï¼šå¯ç”¨Flexboxå¸ƒå±€ */
            justify-content: center;
            /* æ–°å¢ï¼šæ°´å¹³å±…ä¸­ */
            align-items: center;
            /* æ–°å¢ï¼šå‚ç›´å±…ä¸­ */
            border: 3px solid #007BFF;
            /* ä¿®æ”¹ï¼šä½¿ç”¨ä¸»é¢˜è‰² */
            border-radius: 12px;
            /* æ–°å¢ï¼šåœ†è§’ */
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
            /* æ–°å¢ï¼šé˜´å½± */
            transition: border-color 0.3s ease;
            /* æ–°å¢ï¼šè¿‡æ¸¡æ•ˆæœ */

        }

        /* æ·»åŠ åª’ä½“æŸ¥è¯¢ */
        @media (min-width: 1500px) {
            .ggb-container {
                width: 1280px;
                /* å½“å±å¹•å®½åº¦ <= 1500px æ—¶è®¾ç½®å›ºå®šå®½åº¦ */
            }
        }

        #ggb-element {
            position: relative;
            /* ä¿®æ”¹ï¼šä»absoluteæ”¹ä¸ºrelative */
            /* ç§»é™¤åŸæœ‰çš„å®šä½æ ·å¼ */

        }




        /* æ–°å¢å¸ƒå±€å®¹å™¨æ ·å¼ */
        /* .main-container {
            display: flex;
            
        } */

        /* æ–‡ä»¶ç›®å½•å®¹å™¨ */
        .file-list-container {
            width: 300px;
            height: 100vh;
            position: fixed;
            left: -300px;
            top: 0;
            overflow: auto;
            border-right: 1px solid #ddd;
            background-color: #fff;
            transition: left 0.3s ease;
            z-index: 1000;
            font-size: 12px;

        }

        .file-list-container.show {
            left: 0;
        }

        /* åˆ‡æ¢æŒ‰é’® */
        .toggle-btn {
            position: fixed;
            left: 5px;
            top: 150px;
            z-index: 1001;
            padding: 10px;
            background: rgba(255, 255, 255, 0.3);
            /* åŠé€æ˜èƒŒæ™¯ */
            border: 1px solid rgba(221, 221, 221, 0.3);
            /* æ›´é€æ˜çš„è¾¹ç¼˜ */
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            width: 50px;
            /* æ›´å¤§çš„å®½åº¦ */
            height: 50px;
            /* æ›´å¤§çš„é«˜åº¦ */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .toggle-btn:active {
            transform: scale(0.95);
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .toggle-btn.active {
            background-color: rgba(0, 123, 255, 0.3);
            /* åŠé€æ˜ä¸»é¢˜è‰² */
            color: #fff;
            border-color: rgba(0, 123, 255, 0.3);
            /* åŠé€æ˜ä¸»é¢˜è‰² */
        }


        /* æ·»åŠ ä»¥ä¸‹æ ·å¼ */
        #current-file-title {
            margin-bottom: 1.25rem;
            /* 20px */
        }
    </style>
</head>

<body>

    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">
            <img src="../images/logo.svg" width="40" height="40" alt="æ–‡ä»¶è§†ç•Œ">
            <span style="margin-left: 10px;">æ–‡ä»¶è§†ç•Œ</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item">
                    <a class="nav-link" href="/">é¦–é¡µ</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../upload.html">ä¸Šä¼ æ–‡ä»¶</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="../ggb/GeoGebra/HTML5/5.0/GeoGebra.html" target="_blank">GGBç¼–è¾‘</a>
                </li>

            </ul>
        </div>
    </nav>

    <!-- æ–°å¢æ ‡é¢˜æ˜¾ç¤º -->
    <div id="current-file-title" class="mx-auto text-center text-primary font-weight-bold" style="font-size: 2rem;">
    </div>
    <!-- <div id="ggb-element" style="margin:auto"></div> -->
    <div class="main-container">
        <!-- å·¦ä¾§æ–‡ä»¶ç›®å½• -->
        <div class="file-list-container bg-light">
            <div id="fileListContainer" class="p-3">
                <!-- ä½¿ç”¨ Bootstrap æ ·å¼ç¾åŒ–æ–‡ä»¶åˆ—è¡¨ -->
            </div>
        </div>

        <!-- åˆ‡æ¢æŒ‰é’® -->
        <div class="toggle-btn" onclick="toggleFileList()">â˜°</div>

        <!-- æ–°å¢ï¼šå·¥å…·æ åˆ‡æ¢æŒ‰é’® -->
        <div class="toggle-btn" style="right: 2%; left: auto;" onclick="toggleToolBar()">ğŸ”§</div>

        <div class="ggb-container">
            <div id="loading" class="sk-spinner-pulse"></div>
            <div id="ggb-element"></div>
        </div>
    </div>

    <!-- å¼•å…¥ Bootstrap 4 JS å’Œä¾èµ– -->
    <script src="../js/jquery.min.js"></script>
    <script src="../js/bootstrap4.min.js"></script>
    <script>
        //GeoGebra Apps APIå‚è€ƒï¼šhttps://geogebra.github.io/integration/basic-embedding-options.html
        //GeoGebra App Parameterså‚è€ƒï¼šhttps://geogebra.github.io/docs/reference/en/GeoGebra_App_Parameters/
        const queryString = location.search; // "?path=/mydisk/file-browser/public/ggb/test.ggb"

        // è§£ææŸ¥è¯¢å­—ç¬¦ä¸²ä¸ºURLSearchParamså¯¹è±¡
        const queryParams = new URLSearchParams(queryString);
        //let ggbFilePath = queryParams.has('path') ? queryParams.get('path') : ""; // æ·»åŠ é”™è¯¯å¤„ç†
        // åœ¨è·å–è·¯å¾„æ—¶æ·»åŠ IPåœ°å€
        let ggbFilePath = queryParams.has('path') ? 
        `https://geomath.icu:8080${queryParams.get('path')}` : "";
        //let viewportWidth = window.innerWidth; // è§†å£å®½åº¦
        //let viewportHeight = window.innerHeight; // è§†å£é«˜åº¦
        let ggbAppletConfig = {
            "appName": "classic",
            "scaleContainerClass": "ggb-container", // æ›´æ–°å®¹å™¨ç±»å
            "showToolBar": false,
            "showAlgebraInput": false,
            "showMenuBar": false,
            "filename": ggbFilePath,
            //åº”ç”¨é«˜ä¸å®½
            "width": 1280,
            "height": 720,
            "borderColor": "#3c3c3c",
            "showFullscreenButton": true,
            showResetIcon: true,
            enableRightClick: false,

        };

        // å°è£…åˆå§‹åŒ–GGBAppletçš„å‡½æ•°
        function initGGBApplet(config) {
            let applet = new GGBApplet(config, true);
            applet.setHTML5Codebase('./GeoGebra/HTML5/5.0/web3d/');
            applet.inject('ggb-element', 'html5');
            document.getElementById('loading').style.display = 'block';
            // æ›´æ–°æ ‡é¢˜æ˜¾ç¤º
            updateTitle(config.filename);
            observe();
            console.log('Height:', window.innerHeight, 'Width:', window.innerWidth);
            return applet;
        }

        // æ–°å¢ï¼šæ›´æ–°æ ‡é¢˜å‡½æ•°
        function updateTitle(filePath) {
            const titleElement = document.getElementById('current-file-title');
            if (filePath) {
                const fileName = filePath.split('/').pop();
                titleElement.textContent = `${fileName}`;
            } else {
                titleElement.textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
            }
        }

        window.addEventListener("DOMContentLoaded", function () {

            fileVue.setConfig({
                showHeader: false,
                showDate: false,
                showDownload: false,
                initialPath: 'ggb/ggbResources',
            });
            fileVue.handleFileClick = function (item) {
                const extension = item.name.split('.').pop().toLowerCase();
                if (extension === 'ggb') {
                    let name = item.path;
                    ggbAppletConfig.filename ="https://geomath.icu:8080" +name;
                    initGGBApplet(ggbAppletConfig);
                }
            }
            initGGBApplet(ggbAppletConfig);
            let checkApplet = setInterval(function () {
                if (typeof ggbApplet !== 'undefined' && ggbApplet.getWidth) {
                    clearInterval(checkApplet);

                    // Add resize handler after applet is ready
                    window.addEventListener("resize", function () {
                        let scale = Math.min(
                            window.innerWidth / ggbApplet.getWidth(),
                            window.innerHeight / ggbApplet.getHeight()
                        );
                        document.getElementById('ggb-element').style.transform = `scale(${scale})`;
                    });
                }
            }, 100);
        });



        // åˆ‡æ¢æ–‡ä»¶åˆ—è¡¨æ˜¾ç¤ºçŠ¶æ€
        function toggleFileList() {
            const fileList = document.querySelector('.file-list-container');
            const toggleBtn = document.querySelector('.toggle-btn');
            fileList.classList.toggle('show');
            toggleBtn.classList.toggle('active'); // åˆ‡æ¢ active ç±»
        }
        // æ–°å¢ï¼šç‚¹å‡»å¤–éƒ¨åŒºåŸŸéšè—æ–‡ä»¶åˆ—è¡¨
        document.addEventListener('click', function (event) {
            const fileList = document.querySelector('.file-list-container');
            const toggleBtn = document.querySelector('.toggle-btn');

            // å¦‚æœç‚¹å‡»çš„ä¸æ˜¯æ–‡ä»¶åˆ—è¡¨åŒºåŸŸæˆ–åˆ‡æ¢æŒ‰é’®ï¼Œä¸”æ–‡ä»¶åˆ—è¡¨æ˜¯å¯è§çš„
            if (!fileList.contains(event.target) && !toggleBtn.contains(event.target) && fileList.classList.contains('show')) {
                fileList.classList.remove('show');
                toggleBtn.classList.remove('active');
            }
        });

        // é˜»æ­¢æ–‡ä»¶åˆ—è¡¨åŒºåŸŸå†…çš„ç‚¹å‡»äº‹ä»¶å†’æ³¡
        document.querySelector('.file-list-container').addEventListener('click', function (event) {
            event.stopPropagation();
        });

        // æ–°å¢ï¼šåˆ‡æ¢å·¥å…·æ æ˜¾ç¤ºçŠ¶æ€çš„å‡½æ•°
        function toggleToolBar() {
            if (typeof ggbApplet !== 'undefined') {
                const isToolBarVisible = !ggbAppletConfig.showToolBar;
                ggbAppletConfig.showToolBar = isToolBarVisible;
                ggbAppletConfig.showAlgebraInput = isToolBarVisible;
                ggbAppletConfig.showMenuBar = isToolBarVisible;
                ggbAppletConfig.enableRightClick = isToolBarVisible;

                // é‡æ–°åˆå§‹åŒ– GGBApplet
                initGGBApplet(ggbAppletConfig);
            }
        }
        // MutationObserver æ¥å£æä¾›äº†ç›‘è§†å¯¹ DOM æ ‘æ‰€åšæ›´æ”¹çš„èƒ½åŠ›ã€‚
        let target = document.body;
        let loading = document.getElementById('loading');
        function observe() {
            const checkInterval = setInterval(() => {
                if (document.getElementsByClassName('EuclidianPanel').length > 0) {
                    loading.style.display = 'none';
                    clearInterval(checkInterval);
                }
            }, 100); // æ¯100æ¯«ç§’æ£€æŸ¥ä¸€æ¬¡
        }
        observe()   
    </script>
    <!-- é¡µè„š -->
    <footer>
        <div class="container">
            <span class="text-muted">Â© 2025 303218145@qq.com</span>
        </div>
    </footer>


    </div>
</body>

</html>